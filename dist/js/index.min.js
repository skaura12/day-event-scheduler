!function(e){function t(t,n){if(this.$ele=t,this.options=e.extend({},e.fn[a].defaults,n),localStorage.getItem("events"))try{this.events=JSON.parse(localStorage.getItem("events")),console.log("events",this.events)}catch(e){console.log("Can not read localStorage as JSON")}else this.events=[];this.init()}function n(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}function i(e,t){var n=e.filter(function(e){return e.id===t});return n[0]}var a="dayPlanner";t.prototype={init:function(){var e=this;e._buildTemplate(),e.widthForOneMinute=e.$ele.find(".time-slot-box").outerWidth()/60,e._attachEvents(),e._addEventsFromHistory()},_buildTemplate:function(){var t=this,n=this.options.startTime,i=this.options.endTime,a=e("<div class='headings-row'></div>"),d=e("<div class='time-slot-row'></div>"),o=moment.duration(moment(i,"h:mma").diff(moment(n,"h:mma"))).asMinutes()/60,m=moment.duration(moment(i,"h:mma").diff(moment(n,"h:mma"))).asMinutes()/30,s=0;for(boxStartTime=n;s!=o;)boxEndTime=moment(boxStartTime,"h:mma").add(60,"minutes").format("h:mma"),e("<div class='heading'>"+boxStartTime+"</div>").width(100/o+"%").appendTo(a),e("<div class='time-slot-box' data-startTime='"+boxStartTime+"' data-endTime='"+boxEndTime+"'></div>").width(100/o+"%").appendTo(d),boxStartTime=boxEndTime,++s;for(s=0;s!=m;);e("<div class='day-timeline'></div>").append(a).append(d).appendTo(t.$ele);var l='<div id= "add-event-modal" class="modal fade" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">Event</h4></div><div class="modal-body"><p class="event-name-row"><label>Name</label><input name="event-name" type="text" class="name"></p><p id="event-duration"><label>From</label><input type="text" class="time start" /> <label>To</label><input type="text" class="time end" /></p></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Discard</button><button type="button" class="btn btn-primary delete">Delete</button><button type="button" class="btn btn-primary save">Save</button></div></div></div></div>';e(l).appendTo(t.$ele)},_attachEvents:function(){var t=this;t.$ele.find(".time-slot-box").on("click",function(n){var i=e(n.target).data("starttime"),a=e(n.target).data("endtime");console.log(i),console.log(a),t.$ele.find("#add-event-modal").data("mode","new"),e("#add-event-modal").modal("show"),t.$ele.find("#event-duration .start").timepicker("setTime",i),t.$ele.find("#event-duration .end").timepicker("setTime",a),t.$ele.find("#add-event-modal input[name='event-name']").val(""),t.$ele.find("#add-event-modal .btn.delete").addClass("hidden")}),t.$ele.find(".btn.save").on("click",function(a,d){var a,o,m,s=t.$ele.find("#add-event-modal input[name='event-name']").val(),l=t.$ele.find("#event-duration .start").val(),r=t.$ele.find("#event-duration .end").val(),d=t.$ele.find("#add-event-modal").data("mode");"edit"===d?m=t._checkEventValidity({mode:"edit",from:l,to:r,id:t.$ele.find("#add-event-modal").data("id")}):"new"===d&&(m=t._checkEventValidity({mode:"new",from:l,to:r})),m&&("new"===d?(a={id:n()},t.events.push(a),o=e("<div class='event'></div>").attr("data-id",a.id),o.appendTo(t.$ele.find(".day-timeline"))):"edit"===d&&(a=i(t.events,t.$ele.find("#add-event-modal").data("id")),o=t.$ele.find(".day-timeline .event[data-id='"+a.id+"']")),a.name=s,a.from=l,a.to=r,t._updateLocalStorage(),o.text(a.name).attr("title",a.name),t._positionEventOnTimeline(a),e("#add-event-modal").modal("hide"))}),t.$ele.find(".btn.delete").on("click",function(){var n,i=t.$ele.find("#add-event-modal").data("id");t.events.forEach(function(e,t){e.id===i&&(n=t)}),t.events.splice(n,1),t._updateLocalStorage(),t.$ele.find(".day-timeline .event[data-id='"+i+"']").remove(),e("#add-event-modal").modal("hide")}),t.$ele.find(".day-timeline").on("click",".event",function(n){var n=i(t.events,e(n.target).data("id"));t.$ele.find("#event-duration .start").timepicker("setTime",n.from),t.$ele.find("#event-duration .end").timepicker("setTime",n.to),t.$ele.find("#add-event-modal input[name='event-name']").val(n.name),t.$ele.find("#add-event-modal").data("mode","edit").data("id",n.id),e("#add-event-modal").modal("show")}),t.$ele.find("#add-event-modal").on("hide.bs.modal",function(t){e(t.target).find(".btn.delete").removeClass("hidden")}),e("#event-duration .start").timepicker({showDuration:!1,timeFormat:"g:ia",orientation:"b",minTime:t.options.startTime,maxTime:t.options.endTime}),e("#event-duration .end").timepicker({showDuration:!0,timeFormat:"g:ia",orientation:"b",minTime:t.options.startTime,maxTime:t.options.endTime});var a=document.getElementById("event-duration");new Datepair(a);e(window).on("resize",function(e){t.resize()})},_checkEventValidity:function(e){var t=this,n=moment(e.from,"h:mma"),i=moment(e.to,"h:mma");if(n.isAfter(i))return alert("Event Start Time cannot be after Event End Time"),!1;if(moment.duration(i.diff(n)).asMinutes()<30)return alert("Event Duration can not be less than 30 minutes"),!1;if(moment.duration(i.diff(n)).asMinutes()>240)return alert("Event Duration can not be more than 4 hours"),!1;for(var a=0;a<t.events.length;++a)if((moment(t.events[a].from,"h:mma").isBetween(n,i)||moment(t.events[a].to,"h:mma").isBetween(n,i)||n.isBetween(moment(t.events[a].from,"h:mma"),moment(t.events[a].to,"h:mma"))||i.isBetween(moment(t.events[a].from,"h:mma"),moment(t.events[a].to,"h:mma")))&&("new"===e.mode||"edit"===e.mode&&t.events[a].id!=e.id))return alert("Can not have overlapping events.Please reschedule this or other events"),!1;return!0},_updateLocalStorage:function(){var e=this;localStorage.setItem("events",JSON.stringify(e.events))},_addEventsFromHistory:function(){var t=this;t.events.forEach(function(n){e("<div class='event'></div>").attr("data-id",n.id).text(n.name).attr("title",n.name).appendTo(t.$ele.find(".day-timeline")),t._positionEventOnTimeline(n)})},_positionEventOnTimeline:function(e){var t,n,i=this,a=i.$ele.find(".day-timeline .event[data-id='"+e.id+"']");t=moment(e.to,"h:mma").diff(moment(e.from,"h:mma"),"minutes"),n=moment(e.from,"h:mma").diff(moment(i.options.startTime,"h:mma"),"minutes")*i.widthForOneMinute,a.width(t*i.widthForOneMinute).css("left",n)},resize:function(){var e=this;e.widthForOneMinute=e.$ele.find(".time-slot-box").outerWidth()/60,e.events.forEach(function(t){e._positionEventOnTimeline(t)})},destroy:function(){this.$ele.empty(),e.data(this.$ele,"plugin_"+a,null)}},e.fn[a]=function(n){var i=arguments;if(void 0==n||"object"==typeof n)return this.each(function(){e.data(this,"plugin_"+a)||e.data(this,"plugin_"+a,new t(e(this),n))});if("string"==typeof n&&"_"!==n[0]&&"init"!==n){var d;return this.each(function(){var o=e.data(this,"plugin_"+a);o instanceof t&&"function"==typeof o[n]&&(d=o[n].apply(o,Array.prototype.slice.call(i,1)))}),void 0!==d?d:this}},e.fn[a].defaults={date:new Date,startTime:"9:00am",endTime:"5:00pm"}}(jQuery);