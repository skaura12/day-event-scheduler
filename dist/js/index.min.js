!function(e){function t(t,n){if(this.$ele=t,this.options=e.extend({},e.fn[i].defaults,n),localStorage.getItem("date")===moment().format("D/MM/YYYY")&&localStorage.getItem("events"))try{this.events=JSON.parse(localStorage.getItem("events"))}catch(e){console.log("Can not read localStorage as JSON")}else this.events=[],localStorage.setItem("date",moment().format("D/MM/YYYY")),localStorage.setItem("events",JSON.stringify(this.events));this.init()}function n(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}function a(e,t){var n=e.filter(function(e){return e.id===t});return n[0]}var i="dayPlanner";t.prototype={init:function(){var e=this;e._buildTemplate(),e.widthForOneMinute=e.$ele.find(".time-slot-box").outerWidth()/30,e._attachEvents(),e._addEventsFromHistory()},_buildTemplate:function(){var t=this,n=this.options.startTime,a=this.options.endTime,i=e("<div class='headings-row'></div>"),d=e("<div class='time-slot-row'></div>"),o=moment.duration(moment(a,"h:mma").diff(moment(n,"h:mma"))).asMinutes()/60,m=moment.duration(moment(a,"h:mma").diff(moment(n,"h:mma"))).asMinutes()/30,s=0;for(boxStartTime=n;s!=o;)boxEndTime=moment(boxStartTime,"h:mma").add(60,"minutes").format("h:mma"),e("<div class='heading'>"+boxStartTime+"</div>").width(100/o+"%").appendTo(i),boxStartTime=boxEndTime,++s;for(s=0,boxStartTime=n;s!=m;)boxEndTime=moment(boxStartTime,"h:mma").add(30,"minutes").format("h:mma"),e("<div class='time-slot-box' data-startTime='"+boxStartTime+"' data-endTime='"+boxEndTime+"'></div>").width(100/m+"%").appendTo(d),boxStartTime=boxEndTime,++s;e("<div class='day-timeline'></div>").append(i).append(d).append("<div class='event-wrapper'></div>").appendTo(t.$ele);var r='<div id= "add-event-modal" class="modal fade" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">Event</h4></div><div class="modal-body"><p class="event-name-row"><label>Name</label><input name="event-name" type="text" class="name"></p><p id="event-duration"><label>From</label><input type="text" class="time start" /> <label>To</label><input type="text" class="time end" /></p></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Discard</button><button type="button" class="btn btn-primary delete">Delete</button><button type="button" class="btn btn-primary save">Save</button></div></div></div></div>';e(r).appendTo(t.$ele)},_attachEvents:function(){var t=this;t.$ele.find(".time-slot-box").on("click",function(n){var a=e(n.target).data("starttime"),i=e(n.target).data("endtime");t.$ele.find("#add-event-modal").data("mode","new"),e("#add-event-modal").modal("show"),t.$ele.find("#event-duration .start").timepicker("setTime",a),t.$ele.find("#event-duration .end").timepicker("setTime",i),t.$ele.find("#add-event-modal input[name='event-name']").val(""),t.$ele.find("#add-event-modal .btn.delete").addClass("hidden")}),t.$ele.find(".btn.save").on("click",function(i,d){var i,o,m,s=t.$ele.find("#add-event-modal input[name='event-name']").val(),r=t.$ele.find("#event-duration .start").val(),l=t.$ele.find("#event-duration .end").val(),d=t.$ele.find("#add-event-modal").data("mode");"edit"===d?m=t._checkEventValidity({mode:"edit",from:r,to:l,name:s,id:t.$ele.find("#add-event-modal").data("id")}):"new"===d&&(m=t._checkEventValidity({mode:"new",from:r,to:l,name:s})),m&&("new"===d?(i={id:n()},t.events.push(i),o=e("<div class='event'></div>").attr("data-id",i.id),o.appendTo(t.$ele.find(".day-timeline .event-wrapper"))):"edit"===d&&(i=a(t.events,t.$ele.find("#add-event-modal").data("id")),o=t.$ele.find(".day-timeline .event[data-id='"+i.id+"']")),i.name=s,i.from=r,i.to=l,t._updateLocalStorage(),o.text(i.name).attr("title",i.name),t._positionEventOnTimeline(i),e("#add-event-modal").modal("hide"))}),t.$ele.find(".btn.delete").on("click",function(){var n,a=t.$ele.find("#add-event-modal").data("id");t.events.forEach(function(e,t){e.id===a&&(n=t)}),t.events.splice(n,1),t._updateLocalStorage(),t.$ele.find(".day-timeline .event-wrapper .event[data-id='"+a+"']").remove(),e("#add-event-modal").modal("hide")}),t.$ele.find(".day-timeline").on("click",".event",function(n){var n=a(t.events,e(n.target).data("id"));t.$ele.find("#event-duration .start").timepicker("setTime",n.from),t.$ele.find("#event-duration .end").timepicker("setTime",n.to),t.$ele.find("#add-event-modal input[name='event-name']").val(n.name),t.$ele.find("#add-event-modal").data("mode","edit").data("id",n.id),e("#add-event-modal").modal("show")}),t.$ele.find("#add-event-modal").on("hidden.bs.modal",function(t){e(t.target).find(".btn.delete").removeClass("hidden")}),e("#event-duration .start").timepicker({showDuration:!1,timeFormat:"g:ia",orientation:"b",minTime:t.options.startTime,maxTime:t.options.endTime}),e("#event-duration .end").timepicker({showDuration:!0,timeFormat:"g:ia",orientation:"b",minTime:t.options.startTime,maxTime:t.options.endTime});var i=document.getElementById("event-duration");new Datepair(i);e(window).on("resize",function(e){t.resize()})},_checkEventValidity:function(e){var t=this,n=moment(e.from,"h:mma"),a=moment(e.to,"h:mma");if(!e.name.length)return alert("Please specify an Event name to continue"),!1;if(n.isAfter(a))return alert("Event Start Time cannot be after Event End Time"),!1;if(moment.duration(a.diff(n)).asMinutes()<30)return alert("Event Duration can not be less than 30 minutes"),!1;if(moment.duration(a.diff(n)).asMinutes()>240)return alert("Event Duration can not be more than 4 hours"),!1;for(var i=0;i<t.events.length;++i)if((moment(t.events[i].from,"h:mma").isBetween(n,a)||moment(t.events[i].to,"h:mma").isBetween(n,a)||n.isBetween(moment(t.events[i].from,"h:mma"),moment(t.events[i].to,"h:mma"))||a.isBetween(moment(t.events[i].from,"h:mma"),moment(t.events[i].to,"h:mma")))&&("new"===e.mode||"edit"===e.mode&&t.events[i].id!=e.id))return alert("Can not have overlapping events.Please reschedule this or other events"),!1;return!0},_updateLocalStorage:function(){var e=this;localStorage.setItem("events",JSON.stringify(e.events))},_addEventsFromHistory:function(){var t=this;t.events.forEach(function(n){e("<div class='event'></div>").attr("data-id",n.id).text(n.name).attr("title",n.name).appendTo(t.$ele.find(".day-timeline .event-wrapper")),t._positionEventOnTimeline(n)})},_positionEventOnTimeline:function(e){var t,n,a=this,i=a.$ele.find(".day-timeline .event[data-id='"+e.id+"']");t=moment(e.to,"h:mma").diff(moment(e.from,"h:mma"),"minutes"),n=moment(e.from,"h:mma").diff(moment(a.options.startTime,"h:mma"),"minutes")*a.widthForOneMinute,i.width(t*a.widthForOneMinute).css("left",n)},resize:function(){var e=this;e.widthForOneMinute=e.$ele.find(".time-slot-box").outerWidth()/60,e.events.forEach(function(t){e._positionEventOnTimeline(t)})},destroy:function(){this.$ele.empty(),e.data(this.$ele,"plugin_"+i,null)}},e.fn[i]=function(n){var a=arguments;if(void 0==n||"object"==typeof n)return this.each(function(){e.data(this,"plugin_"+i)||e.data(this,"plugin_"+i,new t(e(this),n))});if("string"==typeof n&&"_"!==n[0]&&"init"!==n){var d;return this.each(function(){var o=e.data(this,"plugin_"+i);o instanceof t&&"function"==typeof o[n]&&(d=o[n].apply(o,Array.prototype.slice.call(a,1)))}),void 0!==d?d:this}},e.fn[i].defaults={date:new Date,startTime:"9:00am",endTime:"5:00pm"}}(jQuery);